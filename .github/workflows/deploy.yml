name: Deploy to Production

on:
  push:
    tags:
      - 'v*.*.*'  # Trigger on semantic version tags (v1.0.0, v1.2.3, etc.)
  workflow_dispatch:  # Allow manual deployment
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

jobs:
  # Verify all tests pass before deployment
  verify-tests:
    name: Verify Tests Pass
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r tests/requirements.txt
      
      - name: Run unit tests
        run: |
          pytest tests/unit/ -v
      
      - name: Verify coverage threshold
        run: |
          pytest tests/unit/ --cov=services --cov-fail-under=50
        continue-on-error: true  # Don't block deployment for now

  # Build and push Docker images
  build-images:
    name: Build and Push Docker Images
    runs-on: ubuntu-latest
    needs: verify-tests  # Only build if tests pass
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Extract version from tag
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=latest" >> $GITHUB_OUTPUT
          fi
      
      - name: Build and push customer-service
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./docker/Dockerfile.customer_service
          push: true
          tags: |
            w1tz/fintegrate-customer-service:${{ steps.version.outputs.VERSION }}
            ghcr.io/${{ github.repository_owner }}/fintegrate-customer-service:${{ steps.version.outputs.VERSION }}
      
      - name: Build and push event-consumer
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./docker/Dockerfile.event_consumer
          push: true
          tags: |
            w1tz/fintegrate-event-consumer:${{ steps.version.outputs.VERSION }}
            ghcr.io/${{ github.repository_owner }}/fintegrate-event-consumer:${{ steps.version.outputs.VERSION }}

  # Deploy to Docker Compose (Staging/Production)
  deploy-docker-compose:
    name: Deploy to ${{ inputs.environment || 'production' }}
    runs-on: ubuntu-latest
    needs: build-images
    environment:
      name: ${{ inputs.environment || 'production' }}
      url: http://your-server-url:8000  # Replace with actual URL
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set deployment version
        id: deploy-version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=latest" >> $GITHUB_OUTPUT
          fi
      
      - name: Generate deployment summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment**: ${{ inputs.environment || 'production' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Version**: ${{ steps.deploy-version.outputs.VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed by**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Time**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Images Deployed:" >> $GITHUB_STEP_SUMMARY
          echo "- \`w1tz/fintegrate-customer-service:${{ steps.deploy-version.outputs.VERSION }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`w1tz/fintegrate-event-consumer:${{ steps.deploy-version.outputs.VERSION }}\`" >> $GITHUB_STEP_SUMMARY
      
      # Note: Actual deployment would require SSH access to server
      # Uncomment and configure when deploying to real infrastructure
      #
      # - name: Deploy to server via SSH
      #   uses: appleboy/ssh-action@v1.0.0
      #   with:
      #     host: ${{ secrets.SERVER_HOST }}
      #     username: ${{ secrets.SERVER_USER }}
      #     key: ${{ secrets.SERVER_SSH_KEY }}
      #     script: |
      #       cd /app/fintegrate
      #       docker-compose pull
      #       docker-compose up -d
      #       docker-compose ps
      
      - name: Health check (placeholder)
        run: |
          echo "âœ… Deployment complete - health checks would run here"
          # In production, add:
          # curl -f http://your-server/events/health || exit 1
      
      - name: Create deployment notification
        run: |
          echo "ðŸ“¦ Deployment to ${{ inputs.environment || 'production' }} completed successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next steps**:" >> $GITHUB_STEP_SUMMARY
          echo "1. Verify application health at health endpoint" >> $GITHUB_STEP_SUMMARY
          echo "2. Check application logs for errors" >> $GITHUB_STEP_SUMMARY
          echo "3. Run smoke tests against deployed version" >> $GITHUB_STEP_SUMMARY

  # Rollback on failure
  rollback:
    name: Rollback on Deployment Failure
    runs-on: ubuntu-latest
    needs: deploy-docker-compose
    if: failure()  # Only run if deployment failed
    
    steps:
      - name: Rollback notification
        run: |
          echo "## âš ï¸ Deployment Failed - Rollback Required" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Failed deployment**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Environment**: ${{ inputs.environment || 'production' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Rollback Steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. SSH to server" >> $GITHUB_STEP_SUMMARY
          echo "2. Run: \`docker-compose down\`" >> $GITHUB_STEP_SUMMARY
          echo "3. Checkout previous stable tag" >> $GITHUB_STEP_SUMMARY
          echo "4. Run: \`docker-compose up -d\`" >> $GITHUB_STEP_SUMMARY
      
      # Note: Automated rollback would be implemented here
      # For now, this is a notification-only job
