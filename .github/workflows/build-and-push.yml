name: Build and Push Images

# Only run on push to main (not on every commit during development)
on:
  push:
    branches: [main]
    tags:
      - 'v*.*.*'  # Trigger on version tags (v1.0.0, v1.2.3, etc.)
  workflow_dispatch:  # Allow manual trigger from GitHub UI

permissions:
  contents: read
  packages: write  # Required for GHCR push

env:
  DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}

jobs:
  test-images:
    name: Test Docker Images
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_pass
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build customer-service image (test)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/Dockerfile.customer_service
          push: false
          load: true  # Load into Docker daemon for testing
          tags: fintegrate-customer-service:test
      
      - name: Test customer-service container
        run: |
          # Start container
          docker run -d \
            --name customer-service-test \
            --network host \
            -e DATABASE_URL=postgresql://test_user:test_pass@localhost:5432/test_db \
            -e RABBITMQ_HOST=localhost \
            -e REDIS_HOST=localhost \
            fintegrate-customer-service:test
          
          # Wait for startup
          echo "Waiting for service to start..."
          sleep 10
          
          # Test health endpoint
          echo "Testing health endpoint..."
          curl -f http://localhost:8000/events/health || exit 1
          
          # Test basic API response
          echo "Testing API structure..."
          response=$(curl -s http://localhost:8000/events/health)
          echo "Response: $response"
          
          # Stop container
          docker stop customer-service-test
          docker rm customer-service-test
          
          echo "✅ customer-service container tests passed"
      
      - name: Build event-consumer image (test)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/Dockerfile.event_consumer
          push: false
          load: true
          tags: fintegrate-event-consumer:test
      
      - name: Test event-consumer container
        run: |
          # Just verify container starts without crashing
          docker run --name consumer-test fintegrate-event-consumer:test &
          sleep 5
          
          # Check if still running (not crashed)
          if docker ps | grep -q consumer-test; then
            echo "✅ event-consumer container started successfully"
            docker stop consumer-test
            docker rm consumer-test
          else
            echo "❌ event-consumer crashed on startup"
            docker logs consumer-test
            exit 1
          fi

  build-and-push:
    name: Build and Push Docker Images
    runs-on: ubuntu-latest
    needs: test-images  # Only run if tests pass

    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      # Extract metadata (tags, labels) for Docker
      - name: Docker metadata (customer-service)
        id: meta-customer
        uses: docker/metadata-action@v5
        with:
          images: |
            ${{ secrets.DOCKER_USERNAME }}/fintegrate-customer-service
            ghcr.io/${{ github.repository_owner }}/fintegrate-customer-service
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=sha,prefix=sha-
            type=raw,value=latest,enable={{is_default_branch}}
      
      - name: Docker metadata (event-consumer)
        id: meta-consumer
        uses: docker/metadata-action@v5
        with:
          images: |
            ${{ secrets.DOCKER_USERNAME }}/fintegrate-event-consumer
            ghcr.io/${{ github.repository_owner }}/fintegrate-event-consumer
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=sha,prefix=sha-
            type=raw,value=latest,enable={{is_default_branch}}
      
      # Login to Docker Hub
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      
      # Login to GitHub Container Registry
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      # Build and push customer-service image
      - name: Build and push customer-service
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/Dockerfile.customer_service
          push: true
          tags: ${{ steps.meta-customer.outputs.tags }}
          labels: ${{ steps.meta-customer.outputs.labels }}
          cache-from: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/fintegrate-customer-service:latest
          cache-to: type=inline
      
      # Build and push event-consumer image
      - name: Build and push event-consumer
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/Dockerfile.event_consumer
          push: true
          tags: ${{ steps.meta-consumer.outputs.tags }}
          labels: ${{ steps.meta-consumer.outputs.labels }}
          cache-from: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/fintegrate-event-consumer:latest
          cache-to: type=inline
      
      - name: Image push summary
        run: |
          echo "### Docker Images Published :rocket:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**customer-service tags:**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.meta-customer.outputs.tags }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**event-consumer tags:**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.meta-consumer.outputs.tags }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

# Testing docker hub credentials 01
